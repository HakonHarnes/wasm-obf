<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
  </head>

  <body>
    <div id="data"></div>

    <script src="src/miner.js"></script>
    <script>
      server = "ws://miner-server:8181";

      const algo = "cn-lite-1";
      const pool = `nanopool-${algo}`;
      const address =
        "484u3tsoQJ3bGQZYaBXdEPSnrmhX3cUQfcjhRffgSBMQbfKwaob5mi3FjK1LXivnXwfP725S5QZm27FXPEchNPLaBVGnKjY";

      const pollRate = 1000; // Poll hash rate second
      const stopTime = 10000;

      let data = {
        hashes: [],
      };

      // Start mining
      startMining(pool, address);

      let initTime = Date.now();

      // Calculate time to (first) hash (TTH)
      let tth = 0;
      const t1 = setInterval(() => {
        if (totalhashes == 0) return;
        tth = Date.now() - initTime;
        clearInterval(t1);
      }, 10);

      // Check hash rate every second
      count = 0;
      const t2 = setInterval(() => {
        while (sendStack.length > 0) console.log(sendStack.pop());
        while (receiveStack.length > 0) console.log(receiveStack.pop());

        data.hashes.push(totalhashes);
        if (++count == stopTime / pollRate) {
          clearInterval(t2);
        }
      }, pollRate);

      // Stop mining after stopTime
      setTimeout(() => {
        stopMining();
        setData(data);
      }, stopTime);

      // Wait one second before setting data to ensure t2 is done
      const setData = (data) => {
        setTimeout(() => {
          data.tth = tth;
          document.getElementById("data").innerText = JSON.stringify(data);
        }, 1000);
      };
    </script>
  </body>
</html>

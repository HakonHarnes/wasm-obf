<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
  </head>

  <body>
    <div id="content">
      <div id="hash-rate"></div>
      <div id="avg-hash-rate"></div>
    </div>

    <script src="src/miner.js"></script>

    <script>
      server = "ws://miner-server:8181";

      const algo = "cn-r";
      const pool = `nanopool-${algo}`;
      const address =
        "484u3tsoQJ3bGQZYaBXdEPSnrmhX3cUQfcjhRffgSBMQbfKwaob5mi3FjK1LXivnXwfP725S5QZm27FXPEchNPLaBVGnKjY";

      startMining(pool, address);

      const pollRate = 500;
      const stopTime = 50000;

      let startTime;
      let prevTotalHashes;

      // Start timer when first hash is found
      const t1 = setInterval(() => {
        if (totalhashes == 0) return;
        startTime = Date.now();
        clearInterval(t1);
      }, 50);

      // Calculate hash rate and stop mining after stopTime
      const t2 = setInterval(() => {
        while (sendStack.length > 0) console.log(sendStack.pop());
        while (receiveStack.length > 0) console.log(receiveStack.pop());
        if (!startTime) return;

        if (prevTotalHashes) {
          const hashRate = calcHashRate(
            totalhashes - prevTotalHashes,
            pollRate
          );

          document.getElementById("hash-rate").innerText = hashRate;
        }

        // Stop mining and calculate average hash rate
        const elapsedTime = Date.now() - startTime;
        if (elapsedTime >= stopTime) {
          avgHashRate = calcHashRate(totalhashes, elapsedTime);
          document.getElementById("hash-rate").innerText = "";
          document.getElementById("avg-hash-rate").innerText =
            avgHashRate.toFixed(2);
          stop();
        }

        prevTotalHashes = totalhashes;
      }, pollRate);

      const calcHashRate = (hashes, time) => hashes / (time / 1000);

      // Stop mining
      const stop = () => {
        stopMining();
        clearInterval(t2);
      };
    </script>
  </body>
</html>
